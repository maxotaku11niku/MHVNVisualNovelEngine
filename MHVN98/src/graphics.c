#include "platform/pc98_egc.h"

#define VRAM_HIDDEN_OFFSET 0x7D00

//Default text border for testing purposes only
unsigned char tempDefaultTextBorder[1152] =
{
    //Plane 0, top-left
    0b00011000, 0b00000000,
    0b01111111, 0b11111111,
    0b01111111, 0b11111111,
    0b11111111, 0b11000000,
    0b11111111, 0b10111111,
    0b01111110, 0b01111111,
    0b00111101, 0b11111111,
    0b01011011, 0b11111111,
    0b01111011, 0b00000000,
    0b01110111, 0b00000000,
    0b01101111, 0b01111111,
    0b01101111, 0b00000000,
    0b01101111, 0b00000000,
    0b01101111, 0b00000000,
    0b01101111, 0b01111111,
    0b01101111, 0b00000000,
    //Plane 0, top
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000001, 0b10000000,
    0b11111111, 0b10111111,
    0b11111111, 0b10111111,
    0b11111111, 0b10111111,
    0b11111111, 0b10111111,
    0b00000001, 0b10000000,
    0b00000111, 0b11100000,
    0b11111111, 0b11111111,
    0b00000001, 0b10000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    //Plane 0, top-right
    0b00000000, 0b00011000,
    0b11111111, 0b11111110,
    0b11111111, 0b11111110,
    0b00000011, 0b11111111,
    0b11111101, 0b11111111,
    0b11111110, 0b01111110,
    0b11111111, 0b10111100,
    0b11111111, 0b11011010,
    0b00000000, 0b11111010,
    0b00000000, 0b11111100,
    0b11111110, 0b11111110,
    0b01011110, 0b11111110,
    0b00000000, 0b11111110,
    0b00000000, 0b11111110,
    0b11111110, 0b11111110,
    0b01011110, 0b11111110,
    //Plane 0, left
    0b01101111, 0b00000000,
    0b01101111, 0b00000000,
    0b01101111, 0b01111111,
    0b01101111, 0b00000000,
    0b01101111, 0b00000000,
    0b01101111, 0b00000000,
    0b01101111, 0b01111111,
    0b01101111, 0b00000000,
    0b01101111, 0b00000000,
    0b01101111, 0b00000000,
    0b01101111, 0b01111111,
    0b01101111, 0b00000000,
    0b01101111, 0b00000000,
    0b01100000, 0b00000000,
    0b01101111, 0b01111111,
    0b01101111, 0b00000000,
    //Plane 0, center
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    //Plane 0, right
    0b00000000, 0b11111110,
    0b00000000, 0b11111110,
    0b11111110, 0b11111110,
    0b01011110, 0b11111110,
    0b00000000, 0b11011110,
    0b00000000, 0b11011110,
    0b11111110, 0b11011110,
    0b01011110, 0b11011110,
    0b00000000, 0b11110110,
    0b00000000, 0b11011110,
    0b11111110, 0b11011110,
    0b01011110, 0b11011110,
    0b00000000, 0b11011110,
    0b00000000, 0b00000110,
    0b11111110, 0b11111110,
    0b01011110, 0b11111110,
    //Plane 0, bottom-left
    0b01101111, 0b00000000,
    0b01101111, 0b00000000,
    0b01101111, 0b01111111,
    0b01101111, 0b00000000,
    0b01101111, 0b00000000,
    0b01101111, 0b00000000,
    0b01101111, 0b01111111,
    0b01101111, 0b00000000,
    0b01101111, 0b11111111,
    0b01101111, 0b11111111,
    0b01101111, 0b11111111,
    0b01111111, 0b11111111,
    0b01111111, 0b11111111,
    0b00111111, 0b11111111,
    0b01001111, 0b11111111,
    0b00000000, 0b00000000,
    //Plane 0, bottom
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    //Plane 0, bottom-right
    0b00000000, 0b11111110,
    0b00000000, 0b11111110,
    0b11111110, 0b11111110,
    0b01011110, 0b11111110,
    0b00000000, 0b11111110,
    0b00000000, 0b11111110,
    0b11111110, 0b11111110,
    0b00000000, 0b11111110,
    0b11111111, 0b11111110,
    0b11111111, 0b11111110,
    0b11111111, 0b11111110,
    0b11111111, 0b11111110,
    0b11111111, 0b11111110,
    0b11111111, 0b11111100,
    0b11111111, 0b11110010,
    0b00000000, 0b00000000,

    //Plane 1, top-left
    0b11111111, 0b11111111,
    0b10111100, 0b00111111,
    0b11111110, 0b01111111,
    0b11111111, 0b11000000,
    0b11111111, 0b10000000,
    0b01111110, 0b00000000,
    0b10111100, 0b00000000,
    0b10011000, 0b00000000,
    0b10011000, 0b00000000,
    0b10110000, 0b00000000,
    0b11100000, 0b00000000,
    0b11100000, 0b01111111,
    0b11100000, 0b00000000,
    0b11100000, 0b00000000,
    0b11100000, 0b00000000,
    0b11100000, 0b01111111,
    //Plane 1, top
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000001, 0b10000000,
    0b00000001, 0b10000000,
    0b00000001, 0b10000000,
    0b00000001, 0b10000000,
    0b00000001, 0b10000000,
    0b00000001, 0b10000000,
    0b00000111, 0b11100000,
    0b00000011, 0b11000000,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    //Plane 1, top-right
    0b11111111, 0b11111111,
    0b11111100, 0b00111100,
    0b11111110, 0b01111110,
    0b00000011, 0b11111111,
    0b00000001, 0b11111111,
    0b00000000, 0b01111110,
    0b00000000, 0b00111100,
    0b00000000, 0b00011000,
    0b00000000, 0b00011000,
    0b01011111, 0b00001100,
    0b10101111, 0b00000110,
    0b11111111, 0b00000110,
    0b00000001, 0b00000110,
    0b01011111, 0b00000110,
    0b10101111, 0b00000110,
    0b11111111, 0b00000110,
    //Plane 1, left
    0b11100000, 0b00000000,
    0b11100000, 0b00000000,
    0b11100000, 0b00000000,
    0b11101100, 0b01111111,
    0b11101100, 0b00000000,
    0b11101100, 0b00000000,
    0b11101100, 0b00000000,
    0b11101100, 0b01111111,
    0b11101100, 0b00000000,
    0b11101100, 0b00000000,
    0b11101100, 0b00000000,
    0b11101111, 0b01111111,
    0b11101111, 0b00000000,
    0b11100000, 0b00000000,
    0b11100000, 0b00000000,
    0b11100000, 0b01111111,
    //Plane 1, center
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    //Plane 1, right
    0b00000001, 0b00000110,
    0b01011111, 0b00000110,
    0b10101111, 0b00000110,
    0b11111111, 0b11110110,
    0b00000001, 0b11011110,
    0b01011111, 0b11011110,
    0b10101111, 0b11011110,
    0b11111111, 0b11011110,
    0b00000001, 0b11110110,
    0b01011111, 0b11011110,
    0b10101111, 0b11011110,
    0b11111111, 0b11011110,
    0b00000001, 0b11011110,
    0b01011111, 0b00000110,
    0b10101111, 0b00000110,
    0b11111111, 0b00000110,
    //Plane 1, bottom-left
    0b11100000, 0b00000000,
    0b11100000, 0b00000000,
    0b11100000, 0b00000000,
    0b11100000, 0b01111111,
    0b11100000, 0b00000000,
    0b11100000, 0b00000000,
    0b11100000, 0b00000000,
    0b11100000, 0b11111111,
    0b11100000, 0b00000000,
    0b11100000, 0b00001111,
    0b11100000, 0b01110000,
    0b11111111, 0b10000000,
    0b11111110, 0b00000000,
    0b11111100, 0b00000000,
    0b10111000, 0b00000000,
    0b00000000, 0b00000000,
    //Plane 1, bottom
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b11111000, 0b00011111,
    0b00000110, 0b01100000,
    0b00000001, 0b10000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    //Plane 1, bottom-right
    0b00000001, 0b00000110,
    0b01011111, 0b00000110,
    0b10101111, 0b00000110,
    0b11111111, 0b00000110,
    0b00000001, 0b00000110,
    0b01011111, 0b00000110,
    0b10101111, 0b00000110,
    0b11111111, 0b00000110,
    0b00000000, 0b00000110,
    0b11110000, 0b00000110,
    0b00001110, 0b00000110,
    0b00000001, 0b11111110,
    0b00000000, 0b00111110,
    0b00000000, 0b00011100,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,

    //Plane 2, top-left
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00100010, 0b00111111,
    0b00000011, 0b01000000,
    0b00000111, 0b10000000,
    0b00001110, 0b00000000,
    0b00111100, 0b00000000,
    0b00011000, 0b00000000,
    0b00001000, 0b00000000,
    0b00010000, 0b01111111,
    0b00100000, 0b01111111,
    0b00100000, 0b01111111,
    0b00100000, 0b00000000,
    0b00100000, 0b01111111,
    0b00100000, 0b01111111,
    0b00100000, 0b01111111,
    //Plane 2, top
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111110, 0b01111111,
    0b00000000, 0b10000000,
    0b00000000, 0b10000000,
    0b00000000, 0b10000000,
    0b00000000, 0b10000000,
    0b00000000, 0b10000000,
    0b00000000, 0b10000000,
    0b11111000, 0b00111111,
    0b11111100, 0b01111111,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    //Plane 2, top-right
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111100, 0b00100010,
    0b00000010, 0b00000011,
    0b00000001, 0b10000111,
    0b00000000, 0b01001110,
    0b00000000, 0b00111100,
    0b00000000, 0b00011000,
    0b00000000, 0b00001000,
    0b10100000, 0b00000100,
    0b01010000, 0b00000010,
    0b11111110, 0b00000010,
    0b00000000, 0b00000010,
    0b10100000, 0b00000010,
    0b01010000, 0b00000010,
    0b11111110, 0b00000010,
    //Plane 2, left
    0b00100000, 0b00000000,
    0b00100000, 0b01111111,
    0b00100000, 0b01111111,
    0b00100100, 0b01111111,
    0b00100100, 0b00000000,
    0b00100100, 0b01111111,
    0b00100100, 0b01111111,
    0b00100100, 0b01111111,
    0b00100100, 0b00000000,
    0b00100100, 0b01111111,
    0b00100100, 0b01111111,
    0b00100000, 0b01111111,
    0b00101111, 0b00000000,
    0b00100000, 0b01111111,
    0b00100000, 0b01111111,
    0b00100000, 0b01111111,
    //Plane 2, center
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    //Plane 2, right
    0b00000000, 0b00000010,
    0b10100000, 0b00000010,
    0b01010000, 0b00000010,
    0b11111110, 0b00010010,
    0b00000000, 0b01001010,
    0b10100000, 0b01001010,
    0b01010000, 0b01001010,
    0b11111110, 0b01001010,
    0b00000000, 0b00010010,
    0b10100000, 0b01001010,
    0b01010000, 0b01001010,
    0b11111110, 0b01001010,
    0b00000000, 0b01001010,
    0b10100000, 0b00000010,
    0b01010000, 0b00000010,
    0b11111110, 0b00000010,
    //Plane 2, bottom-left
    0b00100000, 0b00000000,
    0b00100000, 0b01111111,
    0b00100000, 0b01111111,
    0b00100000, 0b01111111,
    0b00100000, 0b00000000,
    0b00100000, 0b01111111,
    0b00100000, 0b01111111,
    0b00100000, 0b00000000,
    0b00100000, 0b00000000,
    0b00100000, 0b00001111,
    0b00100000, 0b01110000,
    0b00000001, 0b10000000,
    0b01000010, 0b00000000,
    0b00111100, 0b00000000,
    0b00001000, 0b00000000,
    0b00000000, 0b00000000,
    //Plane 2, bottom
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b11111000, 0b00011111,
    0b00000110, 0b01100000,
    0b00000001, 0b10000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    //Plane 2, bottom-right
    0b00000000, 0b00000010,
    0b10100000, 0b00000010,
    0b01010000, 0b00000010,
    0b11111110, 0b00000010,
    0b00000000, 0b00000010,
    0b10100000, 0b00000010,
    0b01010000, 0b00000010,
    0b00000000, 0b00000010,
    0b00000000, 0b00000010,
    0b11110000, 0b00000010,
    0b00001110, 0b00000010,
    0b00000001, 0b11000010,
    0b00000000, 0b00100010,
    0b00000000, 0b00011100,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,

    //Plane 3, top-left
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111101, 0b11000000,
    0b11111100, 0b10111111,
    0b11111000, 0b01111111,
    0b11110001, 0b11111111,
    0b11000011, 0b11111111,
    0b11100111, 0b11111111,
    0b11110111, 0b11111111,
    0b11101111, 0b10000101,
    0b11011111, 0b10001010,
    0b11011111, 0b10000101,
    0b11011111, 0b10000000,
    0b11011111, 0b10000101,
    0b11011111, 0b10001010,
    0b11011111, 0b10000101,
    //Plane 3, top
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000001, 0b10000000,
    0b11111111, 0b01111111,
    0b11111111, 0b01111111,
    0b11111111, 0b01111111,
    0b11111111, 0b01111111,
    0b11111111, 0b01111111,
    0b11111111, 0b01111111,
    0b11111111, 0b11011111,
    0b11111111, 0b10111111,
    0b11111110, 0b01111111,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    //Plane 3, top-right
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000011, 0b11111101,
    0b11111101, 0b11111100,
    0b11111110, 0b01111000,
    0b11111111, 0b10110001,
    0b11111111, 0b11000011,
    0b11111111, 0b11100111,
    0b11111111, 0b11110111,
    0b10100001, 0b11111011,
    0b01010001, 0b11111101,
    0b11111111, 0b11111101,
    0b00000001, 0b11111101,
    0b10100001, 0b11111101,
    0b01010001, 0b11111101,
    0b11111111, 0b11111101,
    //Plane 3, left
    0b11011111, 0b10000000,
    0b11011111, 0b10000101,
    0b11011111, 0b10001010,
    0b11011011, 0b10000101,
    0b11011011, 0b10000000,
    0b11011011, 0b10000101,
    0b11011011, 0b10001010,
    0b11011011, 0b10000101,
    0b11011011, 0b10000000,
    0b11011011, 0b10000101,
    0b11011011, 0b10001010,
    0b11011111, 0b10000101,
    0b11010000, 0b10000000,
    0b11011111, 0b10000101,
    0b11011111, 0b10001010,
    0b11011111, 0b10000101,
    //Plane 3, center
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    //Plane 3, right
    0b00000001, 0b11111101,
    0b10100001, 0b11111101,
    0b01010001, 0b11111101,
    0b11111111, 0b11101101,
    0b00000001, 0b10110101,
    0b10100001, 0b10110101,
    0b01010001, 0b10110101,
    0b11111111, 0b10110101,
    0b00000001, 0b11101101,
    0b10100001, 0b10110101,
    0b01010001, 0b10110101,
    0b11111111, 0b10110101,
    0b00000001, 0b10110101,
    0b10100001, 0b11111101,
    0b01010001, 0b11111101,
    0b11111111, 0b11111101,
    //Plane 3, bottom-left
    0b11011111, 0b10000000,
    0b11011111, 0b10000101,
    0b11011111, 0b10001010,
    0b11011111, 0b10000101,
    0b11011111, 0b10000000,
    0b11011111, 0b10000101,
    0b11011111, 0b10001010,
    0b11011111, 0b11111111,
    0b11011111, 0b11111111,
    0b11011111, 0b11111111,
    0b11011111, 0b11110000,
    0b11111111, 0b10000000,
    0b11111110, 0b00000000,
    0b11111100, 0b00000000,
    0b11111000, 0b00000000,
    0b11100000, 0b00000000,
    //Plane 3, bottom
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000000, 0b00000000,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b11111111, 0b11111111,
    0b00000111, 0b11100000,
    0b00000001, 0b10000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    0b00000000, 0b00000000,
    //Plane 3, bottom-right
    0b00000001, 0b11111101,
    0b10100001, 0b11111101,
    0b01010001, 0b11111101,
    0b11111111, 0b11111101,
    0b00000001, 0b11111101,
    0b10100001, 0b11111101,
    0b01010001, 0b11111101,
    0b11111111, 0b11111101,
    0b11111111, 0b11111101,
    0b11111111, 0b11111101,
    0b00001111, 0b11111101,
    0b00000001, 0b10111101,
    0b00000000, 0b00011101,
    0b00000000, 0b00000011,
    0b00000000, 0b00001111,
    0b00000000, 0b00000111,
};

void LoadTextBoxIntoVRAM()
{
    EGCDisable();

    __asm (
        "movw $0xA800, %%ax\n\t" //Plane 0 segment
        "movw %%ax, %%es\n\t"
        "movw %0, %%si\n\t"
        "movw %1, %%di\n\t"
        "movw $144, %%cx\n\t"
        "rep movsw\n\t"
        "movw $0xB000, %%ax\n\t" //Plane 1 segment
        "movw %%ax, %%es\n\t"
        "movw %1, %%di\n\t"
        "movw $144, %%cx\n\t"
        "rep movsw\n\t"
        "movw $0xB800, %%ax\n\t" //Plane 2 segment
        "movw %%ax, %%es\n\t"
        "movw %1, %%di\n\t"
        "movw $144, %%cx\n\t"
        "rep movsw\n\t"
        "movw $0xE000, %%ax\n\t" //Plane 3 segment
        "movw %%ax, %%es\n\t"
        "movw %1, %%di\n\t"
        "movw $144, %%cx\n\t"
        "rep movsw\n\t"
    : : "rmi" (tempDefaultTextBorder), "i" (VRAM_HIDDEN_OFFSET) : "%ax", "%si", "%di", "%cx", "%es");

    EGCEnable();
    egc_planeaccess(0xF);
    egc_mask(0xFFFF);
    egc_bgcolour(0xC);
    SetEGCToMonochromeDrawMode();
}

void DrawTextBox(int x, int y, int w, int h)
{
    SetEGCToVRAMBlit();
    egc_bitlen(16);
    int bytex = ((x + 0xF) & 0xFFF0) >> 3;
    int bytew = ((w + 0xF) & 0xFFF0) >> 3;
    int wordw = ((w + 0xF) & 0xFFF0) >> 4;
    int trueh = (h + 0xF) & 0xFFF0;
    int tileh = trueh >> 4;
    int tlpos = bytex + 80 * y;
    int trpos = tlpos + bytew - 2;
    int blpos = bytex + 80 * (y + trueh - 16);
    int brpos = blpos + bytew - 2;
    int tpos = tlpos + 2;
    int bpos = blpos + 2;
    int lpos = tlpos + 1280;
    int rpos = trpos + 1280;
    int cpos = lpos + 2;
    int unrolledIter = ((tileh - 3) >> 2) + 1;
    int jumpAmt = (3 - ((tileh - 3) & 0x3)) * 5; //stosw + add r16, imm16 is 5 bytes
    int centerh = tileh - 2;
    int centerw = wordw - 2;
    int addamt = 2 * (40 - centerw);
    int extAddamt = addamt + 1200;
    int vertSubAmt = 1280 * centerh - 80;

    __asm (
        "movw $0xA800, %%ax\n\t"
        "movw %%ax, %%ds\n\t"
        "movw %%ax, %%es\n\t" //Point both data segments to plane 0
        "movw $0x7D00, %%si\n\t" //Top left tile
        "movw %0, %%di\n\t"
        "leaw 0x500(%%di), %%bx\n\t"
        "movw $78, %%dx\n\t"
        ".loop1%=: movsw\n\t"
        "addw %%dx, %%di\n\t"
        "movsw\n\t"
        "addw %%dx, %%di\n\t"
        "movsw\n\t"
        "addw %%dx, %%di\n\t"
        "movsw\n\t"
        "addw %%dx, %%di\n\t"
        "cmpw %%bx, %%di\n\t"
        "jne .loop1%=\n\t"

        "movw $0x7D40, %%si\n\t" //Top right tile
        "movw %1, %%di\n\t"
        "leaw 0x500(%%di), %%bx\n\t"
        ".loop2%=: movsw\n\t"
        "addw %%dx, %%di\n\t"
        "movsw\n\t"
        "addw %%dx, %%di\n\t"
        "movsw\n\t"
        "addw %%dx, %%di\n\t"
        "movsw\n\t"
        "addw %%dx, %%di\n\t"
        "cmpw %%bx, %%di\n\t"
        "jne .loop2%=\n\t"

        "movw $0x7DC0, %%si\n\t" //Bottom left tile
        "movw %2, %%di\n\t"
        "leaw 0x500(%%di), %%bx\n\t"
        ".loop3%=: movsw\n\t"
        "addw %%dx, %%di\n\t"
        "movsw\n\t"
        "addw %%dx, %%di\n\t"
        "movsw\n\t"
        "addw %%dx, %%di\n\t"
        "movsw\n\t"
        "addw %%dx, %%di\n\t"
        "cmpw %%bx, %%di\n\t"
        "jne .loop3%=\n\t"

        "movw $0x7E00, %%si\n\t" //Bottom right tile
        "movw %3, %%di\n\t"
        "leaw 0x500(%%di), %%bx\n\t"
        ".loop4%=: movsw\n\t"
        "addw %%dx, %%di\n\t"
        "movsw\n\t"
        "addw %%dx, %%di\n\t"
        "movsw\n\t"
        "addw %%dx, %%di\n\t"
        "movsw\n\t"
        "addw %%dx, %%di\n\t"
        "cmpw %%bx, %%di\n\t"
        "jne .loop4%=\n\t"

        "movw $0x7D60, %%si\n\t" //Left tile
        "movw %4, %%di\n\t"
        "movw $.loop51%=, %%bx\n\t"
        "addw %10, %%bx\n\t"
        "movw $16, %%dx\n\t"
        ".loop5%=: lodsw\n\t"
        "movw %9, %%cx\n\t"
        "jmp %%bx\n\t"
        ".loop51%=: stosw\n\t"
        "addw $1278, %%di\n\t"
        "stosw\n\t"
        "addw $1278, %%di\n\t"
        "stosw\n\t"
        "addw $1278, %%di\n\t"
        "stosw\n\t"
        "addw $1278, %%di\n\t"
        "decw %%cx\n\t"
        "jnz .loop51%=\n\t"
        "subw %13, %%di\n\t"
        "decw %%dx\n\t"
        "jnz .loop5%=\n\t"

        "movw $0x7DA0, %%si\n\t" //Right tile
        "movw %5, %%di\n\t"
        "movw $.loop61%=, %%bx\n\t"
        "addw %10, %%bx\n\t"
        "movw $16, %%dx\n\t"
        ".loop6%=: lodsw\n\t"
        "movw %9, %%cx\n\t"
        "jmp %%bx\n\t"
        ".loop61%=: stosw\n\t"
        "addw $1278, %%di\n\t"
        "stosw\n\t"
        "addw $1278, %%di\n\t"
        "stosw\n\t"
        "addw $1278, %%di\n\t"
        "stosw\n\t"
        "addw $1278, %%di\n\t"
        "decw %%cx\n\t"
        "jnz .loop61%=\n\t"
        "subw %13, %%di\n\t"
        "decw %%dx\n\t"
        "jnz .loop6%=\n\t"

        "movw $0x7D20, %%si\n\t" //Top tile
        "movw %6, %%di\n\t"
        "leaw 0x500(%%di), %%bx\n\t"
        "movw %12, %%dx\n\t"
        "push %%bp\n\t"
        "movw %11, %%bp\n\t"
        ".loop7%=: lodsw\n\t"
        "movw %%bp, %%cx\n\t"
        "rep stosw\n\t"
        "addw %%dx, %%di\n\t"
        "cmpw %%bx, %%di\n\t"
        "jne .loop7%=\n\t"
        "pop %%bp\n\t"

        "movw $0x7DE0, %%si\n\t" //Bottom tile
        "movw %7, %%di\n\t"
        "leaw 0x500(%%di), %%bx\n\t"
        "movw %12, %%dx\n\t"
        "push %%bp\n\t"
        "movw %11, %%bp\n\t"
        ".loop8%=: lodsw\n\t"
        "movw %%bp, %%cx\n\t"
        "rep stosw\n\t"
        "addw %%dx, %%di\n\t"
        "cmpw %%bx, %%di\n\t"
        "jne .loop8%=\n\t"
        "pop %%bp\n\t"

        "movw $0x7D80, %%si\n\t" //Center tile
        "movw %8, %%di\n\t"
        "movw $16, %%dx\n\t"
        ".loop91%=: lodsw\n\t"
        "movw %14, %%bx\n\t"
        ".loop9%=: movw %11, %%cx\n\t"
        "rep stosw\n\t"
        "addw %15, %%di\n\t"
        "decw %%bx\n\t"
        "jnz .loop9%=\n\t"
        "subw %13, %%di\n\t"
        "decw %%dx\n\t"
        "jnz .loop91%=\n\t"
    : : "m" (tlpos), "m" (trpos), "m" (blpos), "m" (brpos), "m" (lpos), "m" (rpos), "m" (tpos), "m" (bpos), "m" (cpos), "m" (unrolledIter), "m" (jumpAmt), "m" (centerw), "m" (addamt), "m" (vertSubAmt), "m" (centerh), "m" (extAddamt) : "%ax", "%cx", "%dx", "%bx", "%si", "%di", "%ds", "%es");

    SetEGCToMonochromeDrawMode();
}
